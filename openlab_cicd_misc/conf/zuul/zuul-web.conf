<VirtualHost *:80>
  DocumentRoot /var/www/zuul-web
  ServerName status.openlabtesting.org
  ServerAdmin root@status.openlabtesting.org

  LogLevel warn

  Alias "/static" "/var/www/zuul-web"
  AliasMatch "^/status.html$" "/var/www/zuul-web/status.html"
  AliasMatch "^/jobs.html$" "/var/www/zuul-web/jobs.html"
  AliasMatch "^/builds.html$" "/var/www/zuul-web/builds.html"
  AliasMatch "^/$" "/var/www/zuul-web/status.html"


  <Directory /var/www/zuul-web>
      <IfVersion >= 2.4>
          Require all granted
      </IfVersion>
      <IfVersion < 2.4>
          Order deny,allow
          Allow from all
      </IfVersion>
  </Directory>

  # Console-stream needs a special proxy-pass for websocket
  # ProxyPassMatch /(.*)/console-stream ws://127.0.0.1:9000/$1/console-stream nocanon retry=0
  ProxyPass /console-stream ws://127.0.0.1:9000/openlab/console-stream nocanon retry=0

  # Then only the json calls are sent to the zuul-web endpoints
  ProxyPassMatch ^/(.*.json)$ http://127.0.0.1:9000/openlab/$1 nocanon retry=0
  ProxyPassReverse / http://127.0.0.1:9000/


  <Location "/grafana">
    ProxyPass http://127.0.0.1:3000
  </Location>
  ProxyPassReverse /grafana http://127.0.0.1:3000

  ScriptAlias /graphite /usr/share/graphite-web/graphite.wsgi


  Alias /logs /srv/static/logs/
  <Directory /srv/static/logs/>
      <IfVersion >= 2.4>
          Require all granted
      </IfVersion>
      <IfVersion < 2.4>
          Order deny,allow
          Allow from all
      </IfVersion>
      DirectoryIndex disabled
      Options Indexes
  </Directory>

  <IfModule mod_mime.c>
    AddCharset utf-8 .html
    AddCharset utf-8 .json
    AddEncoding gzip .gz
  </IfModule>
  <FilesMatch "(\.html|\.html\.gz)$">
    ForceType text/html
  </FilesMatch>
  <FilesMatch "(\.txt|\.txt\.gz)$">
    ForceType text/javascript
  </FilesMatch>
  <FilesMatch "(\.json|\.json\.gz)$">
    ForceType text/javascript
  </FilesMatch>

  <IfModule mod_cache.c>
    CacheDefaultExpire 5
    <IfModule mod_mem_cache.c>
      CacheEnable mem /status.json
      # 12MByte total cache size.
      MCacheSize 12288
      MCacheMaxObjectCount 10
      MCacheMinObjectSize 1
      # 8MByte max size per cache entry
      MCacheMaxObjectSize 8388608
      MCacheMaxStreamingBuffer 8388608
    </IfModule>
    <IfModule mod_cache_disk.c>
      CacheEnable disk /status.json
      CacheRoot /var/cache/apache2/mod_cache_disk
    </IfModule>
  </IfModule>
</VirtualHost>